<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba del Sistema de Reservas</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            color: white;
            z-index: 1000;
            display: none;
        }
        .notification.error {
            background: #dc3545;
        }
        .notification.success {
            background: #28a745;
        }
        .notification.warning {
            background: #ffc107;
            color: #212529;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Prueba del Sistema de Reservas</h1>
        <p>Esta p√°gina simula el flujo de reservas para probar el sistema de notificaciones y redirecci√≥n.</p>

        <div class="test-section">
            <h3>üìã Test 1: Obtener Mesas Disponibles</h3>
            <button class="button" onclick="testGetTables()">Obtener Mesas</button>
            <div id="tables-result"></div>
        </div>

        <div class="test-section">
            <h3>üö´ Test 2: Reserva Sin Autenticaci√≥n</h3>
            <p>Este test deber√≠a mostrar una notificaci√≥n y redirigir al login.</p>
            <button class="button" onclick="testUnauthenticatedReservation()">Intentar Reserva</button>
            <div id="unauth-result"></div>
        </div>

        <div class="test-section">
            <h3>üîê Test 3: Verificar Estado de Autenticaci√≥n</h3>
            <button class="button" onclick="testAuthStatus()">Verificar Usuario</button>
            <div id="auth-result"></div>
        </div>

        <div class="test-section">
            <h3>üìä Estado del Sistema</h3>
            <div id="system-status">
                <p>Cargando estado del sistema...</p>
            </div>
        </div>
    </div>

    <!-- Notificaci√≥n toast -->
    <div id="notification" class="notification"></div>

    <script>
        // Configurar axios para CSRF
        axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
        
        // Obtener CSRF token
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) {
            axios.defaults.headers.common['X-CSRF-TOKEN'] = metaTag.getAttribute('content');
        }

        // Funci√≥n para mostrar notificaciones
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Test 1: Obtener mesas disponibles
        async function testGetTables() {
            const resultDiv = document.getElementById('tables-result');
            resultDiv.innerHTML = '<div class="info">üîÑ Cargando mesas...</div>';
            
            try {
                const response = await axios.get('/public/tables');
                
                if (response.data.success) {
                    const tables = response.data.tables;
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ √âxito: ${tables.length} mesas encontradas
                            <ul>
                                ${tables.slice(0, 3).map(table => 
                                    `<li>Mesa #${table.table_number} - ${table.capacity} personas - ${table.status}</li>`
                                ).join('')}
                                ${tables.length > 3 ? '<li>... y m√°s</li>' : ''}
                            </ul>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="error">‚ùå Error: No se pudieron obtener las mesas</div>';
                }
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Test 2: Intento de reserva sin autenticaci√≥n
        async function testUnauthenticatedReservation() {
            const resultDiv = document.getElementById('unauth-result');
            resultDiv.innerHTML = '<div class="info">üîÑ Intentando hacer reserva sin autenticaci√≥n...</div>';
            
            // Datos de prueba para la reserva
            const reservationData = {
                table_id: 1,
                reservation_date: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                party_size: 2,
                client_name: 'Usuario Test',
                client_email: 'test@example.com',
                special_requests: 'Prueba del sistema'
            };
            
            try {
                const response = await axios.post('/public/reservations', reservationData);
                
                // Si llegamos aqu√≠, la reserva se proces√≥ (no deber√≠a pasar)
                resultDiv.innerHTML = '<div class="error">‚ùå Error: La reserva se proces√≥ sin autenticaci√≥n</div>';
                
            } catch (error) {
                console.error('Error capturado:', error);
                
                // Verificar si es una redirecci√≥n (status 302)
                if (error.response && error.response.status === 302) {
                    const location = error.response.headers.location || error.response.data.redirect;
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Correcto: Redirecci√≥n detectada
                            <br>üìç Destino: ${location}
                        </div>
                    `;
                    showNotification('Se requiere iniciar sesi√≥n para hacer reservas', 'warning');
                    
                    // Simular redirecci√≥n despu√©s de 3 segundos
                    setTimeout(() => {
                        if (location && location.includes('login')) {
                            showNotification('Redirigiendo al login...', 'info');
                            // En producci√≥n: window.location.href = location;
                        }
                    }, 3000);
                    
                } else if (error.response && error.response.status === 401) {
                    resultDiv.innerHTML = '<div class="success">‚úÖ Correcto: Respuesta 401 (No autorizado)</div>';
                    showNotification('Acceso denegado - Login requerido', 'error');
                    
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå Error inesperado: ${error.message}
                            <br>Status: ${error.response?.status || 'N/A'}
                        </div>
                    `;
                }
            }
        }

        // Test 3: Verificar estado de autenticaci√≥n
        async function testAuthStatus() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.innerHTML = '<div class="info">üîÑ Verificando autenticaci√≥n...</div>';
            
            try {
                // Intentar acceder a una ruta que requiere autenticaci√≥n
                const response = await axios.get('/admin/dashboard');
                
                resultDiv.innerHTML = '<div class="success">‚úÖ Usuario autenticado como administrador</div>';
                
            } catch (error) {
                if (error.response && (error.response.status === 401 || error.response.status === 403)) {
                    resultDiv.innerHTML = '<div class="info">‚ÑπÔ∏è Usuario no autenticado (esperado)</div>';
                } else if (error.response && error.response.status === 302) {
                    resultDiv.innerHTML = '<div class="info">‚ÑπÔ∏è Redirecci√≥n a login detectada</div>';
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                }
            }
        }

        // Cargar estado del sistema al iniciar
        window.onload = function() {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = `
                <div class="info">
                    <h4>üîß Configuraci√≥n del Sistema</h4>
                    <ul>
                        <li>‚úÖ Axios configurado</li>
                        <li>‚úÖ CSRF token ${metaTag ? 'encontrado' : 'no encontrado'}</li>
                        <li>‚úÖ URL base: ${window.location.origin}</li>
                        <li>‚úÖ Rutas configuradas:
                            <ul>
                                <li>/public/tables (GET)</li>
                                <li>/public/reservations (POST)</li>
                                <li>/admin/dashboard (GET)</li>
                            </ul>
                        </li>
                    </ul>
                </div>
            `;
            
            // Auto-ejecutar el primer test
            setTimeout(testGetTables, 1000);
        };
    </script>
</body>
</html>
